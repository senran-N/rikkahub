# 代码卡片化功能

## 功能概述

为RikkaHub项目添加了代码显示卡片化特性，当代码生成完成后会变成可点击的卡片，点击后弹出窗口显示完整代码，使聊天界面更加简洁美观，类似Claude AI的交互体验。

## 功能特点

### 1. 智能卡片化
- 只有超过5行的代码才会显示为卡片形式
- 保持短代码的传统显示方式，避免过度卡片化
- 自动检测代码完成状态，只有完整的代码块才会卡片化

### 2. 简洁的卡片界面
- 显示语言类型和代码行数
- 预览前3行代码内容
- 采用与项目一致的Material Design风格
- 使用项目内置的Lucide图标库

### 3. 悬浮式代码弹窗
- 点击卡片后弹出独立的代码查看窗口
- 弹窗不与边界相连，呈现悬浮效果
- 支持代码语法高亮和选择复制
- 提供复制、预览(HTML)、关闭等功能按钮

### 4. 可配置开关
- 在设置 → 显示设置中添加"代码卡片模式"开关
- 用户可以根据喜好启用或关闭此功能
- 默认启用，提供更好的用户体验

## 实现细节

### 1. 数据层修改
- 在`DisplaySetting`数据类中添加`codeCardMode: Boolean = true`字段
- 更新`PreferencesStore.kt`以支持新的设置项持久化

### 2. UI组件实现
- 修改`HighlightCodeBlock.kt`，添加卡片模式支持
- 新增`CodeCard`私有组件，实现简洁的代码卡片界面
- 新增`CodeDialog`私有组件，实现悬浮式代码查看窗口

### 3. 设置界面更新
- 在`SettingDisplayPage.kt`中添加代码卡片模式的开关
- 支持中英文界面，添加相应的字符串资源

### 4. 字符串资源
- 添加英文资源：`values/strings.xml`
- 添加中文资源：`values-zh/strings.xml`
- 包含功能标题、描述、按钮文本等

## 文件修改清单

### 新增文件
- `docs/code-card-feature.md` - 功能说明文档

### 修改的文件
1. **数据层**
   - `app/src/main/java/me/rerere/rikkahub/data/datastore/PreferencesStore.kt`

2. **UI组件**
   - `app/src/main/java/me/rerere/rikkahub/ui/components/richtext/HighlightCodeBlock.kt`

3. **设置页面**
   - `app/src/main/java/me/rerere/rikkahub/ui/pages/setting/SettingDisplayPage.kt`

4. **字符串资源**
   - `app/src/main/res/values/strings.xml`
   - `app/src/main/res/values-zh/strings.xml`

5. **构建配置**
   - `app/google-services.json` (临时文件，用于编译)

## 使用说明

### 用户操作
1. 打开应用设置 → 显示设置
2. 找到"代码卡片模式"开关
3. 开启后，长代码将显示为卡片形式
4. 点击代码卡片可查看完整代码
5. 在弹窗中可以复制、预览或关闭代码

### 开发者说明
- 卡片化逻辑在`HighlightCodeBlock`组件中实现
- 通过`settings.displaySetting.codeCardMode`控制是否启用
- 只有`completeCodeBlock = true`且行数 > 5的代码才会卡片化
- 保持了原有代码块的所有功能（复制、预览等）

## 技术要点

1. **响应式设计**: 卡片和弹窗都采用响应式布局，适配不同屏幕尺寸
2. **性能优化**: 只有在需要时才创建弹窗组件，减少内存占用
3. **用户体验**: 保持了原有功能的同时，提供了更简洁的界面
4. **可维护性**: 采用Compose声明式UI，代码结构清晰易维护

## 效果展示

- **卡片模式关闭**: 代码以传统的代码块形式显示
- **卡片模式开启**: 长代码显示为简洁的卡片，可点击展开
- **弹窗界面**: 悬浮式窗口显示完整代码，支持所有原有功能

这个功能实现了类似Claude AI的代码显示体验，让聊天界面更加整洁，同时保持了强大的代码查看和操作功能。

## UI设计优化

### 和谐界面设计
- **去除边框阴影**: 卡片和对话框都采用无阴影设计
- **统一背景色**: 使用 `surfaceContainer` 配色，与应用主题保持一致
- **圆角设计**: 卡片8dp圆角，对话框12dp圆角
- **透明度调整**: 背景使用适当的透明度，增强层次感

### 性能优化
- **缓存计算**: 使用 `remember` 缓存卡片模式判断逻辑
- **稳定布局**: 设置预览文本的最小行数为3行，防止内容变化时的抖动
- **移除动画**: 去除 `animateContentSize` 动画，减少布局重计算
- **优化渲染**: 条件渲染减少不必要的组件创建

### 用户体验提升
- **视觉一致性**: 卡片设计与应用整体风格保持一致
- **交互反馈**: 清晰的点击区域和状态反馈
- **信息层次**: 合理的信息排列和视觉权重
- **响应式设计**: 适应不同屏幕尺寸

## 使用示例

### 启用功能
1. 打开 RikkaHub 应用
2. 进入设置页面
3. 找到"显示设置"
4. 开启"代码卡片模式"

### 查看代码
1. 在聊天中遇到长代码块时，会自动显示为卡片
2. 点击卡片展开完整代码
3. 在浮动窗口中查看、复制或预览代码
4. 点击关闭按钮或窗口外区域关闭

## 技术栈
- **UI框架**: Jetpack Compose
- **设计语言**: Material Design 3
- **图标库**: Lucide Icons
- **语法高亮**: 自定义 HighlightText 组件
- **状态管理**: Compose State
- **主题**: 动态颜色主题支持 